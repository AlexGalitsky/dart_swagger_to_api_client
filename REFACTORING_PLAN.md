## План рефакторинга `dart_swagger_to_api_client`

Этот файл описывает выявленные дефекты, технические долги и запланированные улучшения кода.

### 1. Баги

1. **Неверное условие в `_getRequestBodyType` (`EndpointMethodGenerator`)**
   - **Файл**: `lib/src/generators/endpoint_method_generator.dart`
   - **Проблема**: В методе `_getRequestBodyType` используется условие `if (content is! Map && content.isNotEmpty)`, из-за чего ветка с разбором `$ref` никогда не выполняется.
   - **Эффект**: Тип тела запроса по `$ref` фактически никогда не резолвится в модельный тип, что приводит к использованию `Map<String, dynamic>` вместо конкретных модельных классов.
   - **Решение**: Заменить условие на `if (content is Map && content.isNotEmpty)` и добавить тест, который проверяет генерацию метода с модельным типом в `requestBody`.

2. **Странные сообщения об ошибках в сгенерированном коде (`$ _rawPath`)**
   - **Файл**: `lib/src/generators/endpoint_method_generator.dart`
   - **Проблема**: В строках, формирующих сообщения об ошибках (`ApiAuthException`, `ApiServerException`, `ApiClientException`), используется шаблон `'\$ _rawPath'` (с пробелом), из-за чего в рантайме в сообщении появляется буквальный текст `$ _rawPath`, а не значение переменной.
   - **Эффект**: Сообщения об ошибках менее информативны, сложнее диагностировать конкретный путь/эндпоинт.
   - **Решение**: Изменить шаблоны строк на корректную интерполяцию (`'... $_rawPath'`) без лишнего пробела.

3. **Несоответствие между поведением валидации спеки и тестами**
   - **Файлы**: 
     - `lib/src/core/client_generator.dart`
     - `test/api_client_generator_test.dart`
   - **Проблема**: При ошибках валидации спеки сейчас бросается `GenerationException`, в то время как тест `throws StateError when spec has no paths section` ожидает `StateError`.
   - **Эффект**: Тесты отражают устаревшее/изменившееся поведение. Возможна путаница для пользователей библиотеки.
   - **Решение**: Явно зафиксировать, какое исключение является «публичным контрактом» (рекомендуется оставить `GenerationException`), и обновить тесты под текущее поведение.

### 2. Потенциальные проблемы и ограничения

4. **Ограниченное сканирование моделей в `FileBasedModelsResolver`**
   - **Файл**: `lib/src/models/file_based_models_resolver.dart`
   - **Проблема**: Сканирование моделей выполняется с `recursive: false`, из-за чего вложенные поддиректории с моделями игнорируются.
   - **Эффект**: При организации моделей по подпапкам (например, `lib/models/user/user.dart`) типы не будут найдены и не будут использоваться при генерации.
   - **Решение**: 
     - Либо переключиться на `recursive: true`,
     - либо добавить конфигурационную опцию для глубины сканирования и/или явно задокументировать текущее ограничение в `USAGE/DEVELOPERS`.

5. **Busy‑wait при инициализации `FileBasedModelsResolver`**
   - **Файл**: `lib/src/models/file_based_models_resolver.dart`
   - **Проблема**: При параллельных вызовах `_ensureInitialized` используется цикл с `while (_initializing) { await Future.delayed(...); }`.
   - **Эффект**: Некрасивый шаблон синхронизации, потенциально лишние задержки при большом количестве одновременных обращений.
   - **Решение**: Заменить на хранение одного `Future<void>? _initFuture`, который инициализируется при первом вызове и далее просто `await`‑ится остальными вызовами.

### 3. Улучшения API и удобства использования

6. **Сохранение middleware и настроек в `ApiClient.withHeaders`**
   - **Файл**: `lib/src/generators/api_client_class_generator.dart`
   - **Проблема**: В методе `ApiClient.withHeaders` при создании нового `ApiClientConfig` не передаются `requestInterceptors` и `responseInterceptors`. В результате новый клиент может потерять цепочку middleware.
   - **Эффект**: Неочевидное поведение для пользователей, использующих retry/circuit breaker/logging через интерцепторы: при переходе на скопированный клиент с доп. заголовками часть функциональности пропадает.
   - **Решение**:
     - Добавить в `ApiClientConfig` метод `copyWith`, который копирует все поля, включая interceptors и адаптер;
     - Использовать `copyWith` внутри `withHeaders`, меняя только `defaultHeaders`.

7. **Незначительные улучшения API конфигурации**
   - **Файл**: `lib/src/config/config.dart`
   - **Идеи**:
     - Сделать коллекции в `ApiClientConfig` (headers, interceptors) по возможности более явно неизменяемыми (например, через `UnmodifiableListView`/`UnmodifiableMapView`), чтобы предотвратить случайные внешние мутации.
     - Добавить небольшой раздел в документации с рекомендациями по созданию/шарингу `ApiClientConfig` и адаптеров.

### 4. План действий (итерации)

**Итерация 1: Критичные баги генерации**
1. Исправить условие в `_getRequestBodyType` и добавить тест на резолвинг `requestBody` с `$ref`.
2. Исправить строки сообщений об ошибках в `EndpointMethodGenerator` (`$_rawPath`).

**Итерация 2: Поведение ошибок и тесты**
3. Зафиксировать контракт по типу исключения при ошибке валидации спеки и обновить соответствующие тесты.

**Итерация 3: Улучшение API клиента**
4. Обновить `ApiClient.withHeaders`, чтобы он сохранял middleware и остальные настройки `ApiClientConfig` (реализация `copyWith`).

**Итерация 4: Оптимизация и улучшение работы с моделями**
5. Переписать инициализацию `FileBasedModelsResolver` на `Future`‑базовый подход без busy‑wait.
6. Рассмотреть включение рекурсивного сканирования моделей или явное документирование текущего ограничения.

По мере выполнения задач этот план можно расширять и помечать пункты как завершённые.

