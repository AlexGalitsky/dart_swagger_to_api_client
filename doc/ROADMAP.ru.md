dart_swagger_to_api_client — Дорожная карта
===========================================

Этот документ описывает поэтапное развитие отдельного пакета `dart_swagger_to_api_client`,
который строится поверх `dart_swagger_to_models` и отвечает за генерацию
типобезопасного HTTP‑клиента из OpenAPI/Swagger‑спецификаций.

Ключевая идея: **модели и клиент — это разные слои**.

- `dart_swagger_to_models` — отвечает за генерацию null‑safe моделей.
- `dart_swagger_to_api_client` — использует эти модели и генерирует API‑клиент
  (классы `ApiClient`, `UsersApi`, `OrdersApi`, эндпоинт‑методы и т.д.).

Ниже — план версий v0.1–v0.5+.

**Статус реализации**: ✅ v0.1 полностью завершён, частично реализованы v0.2 и v0.4.2.

## v0.1 — Minimal Viable Client (MVP, только `http`) ✅ ЗАВЕРШЕНО

**Цель**: получить рабочий, но минималистичный API‑клиент поверх уже сгенерированных моделей.

### 0.1.1 Базовые типы и инфраструктура ✅

- `lib/src/config/`:
  - ✅ `ApiClientConfig` — базовый URL, заголовки по умолчанию, таймаут, auth, HTTP‑адаптер.
  - ✅ `AuthConfig` — API key / bearer token.
- `lib/src/core/`:
  - ✅ `HttpClientAdapter`, `HttpRequest`, `HttpResponse`.
  - ✅ Конкретный адаптер `HttpHttpClientAdapter` на базе `package:http`.
- Простая авторизация:
  - ✅ API key в header/query (строки из `AuthConfig`).
  - ✅ Bearer token из `AuthConfig` (пока без env‑подстановок).

### 0.1.2 Разбор спеки и простейшая генерация ✅

- ✅ `spec_loader.dart` — минимум, чтобы прочитать OpenAPI/Swagger и пройтись по `paths`.
- ✅ `client_generator.dart`:
  - Генерация одного общего `ApiClient` с `DefaultApi` классом.
- ✅ `endpoint_method_generator.dart`:
  - Методы для `GET`/`POST`/`PUT`/`DELETE`/`PATCH`:
    - ✅ path‑параметры, query‑параметры (примитивные типы).
    - ✅ один JSON‑body (`requestBody` → `Map<String, dynamic>`).
    - ✅ десериализация ответа: `Future<void>`, `Future<Map<String, dynamic>>`, `Future<List<Map<String, dynamic>>>`.

### 0.1.3 CLI и конфиг (минимум) ✅

- ✅ `bin/dart_swagger_to_api_client.dart`:
  - Флаги: `--input`, `--output-dir`, `--config`, `--verbose`, `--quiet`.
- ✅ `dart_swagger_to_api_client.yaml` (минимальный поднабор):
  - `input`, `outputDir`, `client.baseUrl`, `client.headers`, `client.auth`.
- ✅ Приоритет: **CLI > config > defaults** (как в `dart_swagger_to_models`).

### 0.1.4 Пример и smoke‑тест ✅

- ✅ Пример в `example/`:
  - Минимальная OpenAPI‑спека для тестирования.
  - Генерация в `example/generated/` клиента.

## v0.2 — Укрепление ядра и расширение HTTP‑слоя

**Цель**: сделать ядро пригодным для реального прод‑использования.

**Статус**: ⚠️ Частично реализовано (0.2.1, 0.2.2 частично, 0.2.3 полностью)

### 0.2.1 Расширение `HttpClientAdapter` ✅ ЗАВЕРШЕНО

- ✅ Возможность проброса «сырого» клиента (`http.Client`).
- ✅ Базовая стратегия обработки ошибок:
  - ✅ маппинг статусов (2xx / 4xx / 5xx) → свои исключения
    (`ApiClientException`, `ApiServerException`, `ApiAuthException`).
- ✅ Поддержка таймаутов (из `ApiClientConfig.timeout`):
  - ✅ Таймаут передаётся через `HttpRequest.timeout`.
  - ✅ `HttpHttpClientAdapter` использует таймаут через `Future.timeout`.
  - ✅ При таймауте выбрасывается `TimeoutException` с понятным сообщением.

### 0.2.2 Улучшение генерации endpoint‑методов ✅ ЗАВЕРШЕНО

- ✅ Поддержка нескольких `response` схем (выбор по коду 200/201/204).
- ✅ `204 No Content` → `Future<void>`.
- ✅ Улучшение сигнатур методов:
  - ✅ явное разделение `required` / `optional` аргументов.
  - ✅ `Future<void>` для методов без полезного тела ответа.
- ✅ `application/x-www-form-urlencoded` / простых форм:
  - ✅ Поддержка `application/x-www-form-urlencoded` в `requestBody`.
  - ✅ Генерация правильной сериализации для form‑данных (Map → query string).
  - ✅ Автоматическая установка заголовка `Content-Type: application/x-www-form-urlencoded`.
  - ✅ Использование `Map<String, String>` для form‑данных (вместо `Map<String, dynamic>`).

### 0.2.3 DX и логирование ✅ ЗАВЕРШЕНО

- ✅ Флаги CLI: `--verbose`, `--quiet`.
- ✅ Человеческие сообщения:
  - ✅ валидация спецификации (`SpecValidator`) с детальными предупреждениями;
  - ✅ когда endpoint пропущен (unsupported feature);
  - ✅ когда не удалось подобрать модель ответа/запроса.

## v0.3 — Поддержка нескольких HTTP‑клиентов и кастомизация

**Цель**: сделать пакет гибким и расширяемым, как `dart_swagger_to_models` со стилями.

### 0.3.1 Адаптеры `dio` и кастомные клиенты ✅

- ✅ `DioHttpClientAdapter`:
  - ✅ маппинг `HttpRequest`/`HttpResponse` на `dio`.
  - ✅ Поддержка таймаутов через Dio options.
  - ✅ Правильная обработка ошибок DioException.
  - ✅ Экспортирован в публичный API пакета.
- ✅ Поддержка `http.adapter` в конфиге:
  - ✅ `http`, `dio` (реализованы).
  - ✅ `custom` — полная поддержка кастомных адаптеров.
- ✅ Для `custom`:
  - ✅ Генерация документации и примеров использования в сгенерированном коде.
  - ✅ Поддержка `customAdapterType` в конфиге.
  - ✅ Автоматическое включение документации при указании custom адаптера.
  - ✅ Примеры кода для создания и использования custom адаптера.

### 0.3.2 Конфигурация клиента и окружения ✅

- ✅ Расширить конфиг:
  - ✅ `client.auth.bearerTokenEnv` — поддержка чтения bearer token из переменных окружения.
  - ✅ Профили окружений (`environments` в YAML) — `dev`, `staging`, `prod` и т.д.
  - ✅ Метод `AuthConfig.resolveBearerToken()` для разрешения токена (прямое значение или из env).
- ✅ Простая поддержка переключения окружений:
  - ✅ Флаг CLI `--env` → выбор профиля из конфига.
  - ✅ Профили переопределяют базовую конфигурацию (baseUrl, headers, auth).
  - ✅ CLI автоматически объединяет базовую конфигурацию с выбранным профилем.

### 0.3.3 Генерация удобного фасада ✅

- ✅ Доработать `ApiClient`:
  - ✅ Метод `close()` для адаптеров, которым нужен dispose — вызывает `httpClientAdapter.close()`.
  - ✅ «Scoped» клиент с переопределёнными заголовками — метод `withHeaders({...})` возвращает новый `ApiClient` с объединёнными заголовками.
  - ✅ `withHeaders()` сохраняет все остальные параметры конфигурации (baseUrl, timeout, auth, adapter).

## v0.4 — OpenAPI‑feature completeness и связка с моделями

**Цель**: покрыть основные реальные API‑кейсы и сделать связку `models + api_client` удобной.

### 0.4.1 Улучшенная поддержка OpenAPI ✅

- ✅ Более точная работа с `parameters`:
  - ✅ `path` и `query` параметры (уже были реализованы в v0.1).
  - ✅ `header` параметры — добавлены в заголовки запроса.
  - ✅ `cookie` параметры — добавлены в заголовок `Cookie` с правильным кодированием.
- ✅ `requestBody` с несколькими `content` типами:
  - ✅ `application/json` (реализовано в v0.1).
  - ✅ `application/x-www-form-urlencoded` (реализовано в v0.2.2).
- ✅ `multipart/form-data` — реализовано:
  - ✅ Поддержка в генераторе (определение content type).
  - ✅ Обработка в `HttpHttpClientAdapter` (автоматическое создание `MultipartRequest`).
  - ✅ Поддержка `File` и `List<int>` в body для загрузки файлов.
  - ✅ Валидатор принимает `multipart/form-data` как поддерживаемый тип.
- ✅ Базовая поддержка пагинации:
  - ✅ Обнаружение типичных паттернов (query `page`/`offset` + `limit`/`per_page`).
  - ✅ Добавление комментариев в сгенерированный код для endpoints с пагинацией.
  - ⚠️ Генерация helper‑методов — отложено (можно добавить в будущих версиях через флаг).

### 0.4.2 Тесная интеграция с `dart_swagger_to_models` ✅ ЗАВЕРШЕНО

- ✅ Инфраструктура для интеграции:
  - ✅ `ModelsResolver` интерфейс для разрешения `$ref` → Dart типы.
  - ✅ `ModelsConfig`, `ModelsConfigLoader` для чтения `dart_swagger_to_models.yaml`.
  - ✅ `NoOpModelsResolver` как заглушка (используется по умолчанию).
- ✅ Реальная интеграция:
  - ✅ Реализация `FileBasedModelsResolver`, которая сканирует директорию моделей
    из `dart_swagger_to_models.yaml` и находит пути к сгенерированным моделям.
  - ✅ Генерация методов с реальными типами моделей вместо `Map<String, dynamic>`.
  - ✅ Автоматическое добавление импортов для моделей.
  - ✅ Генерация кода десериализации моделей (например, `User.fromJson()`).
  - ✅ Поддержка типов моделей в `requestBody` (например, `required User body`).

### 0.4.3 Документация и примеры ✅

- ✅ Полный README:
  - ✅ End‑to‑end сценарий: spec → models → api_client → вызов API.
  - ✅ Раздел "Getting started" с быстрым стартом.
  - ✅ Примеры использования различных функций.
- ✅ Расширенные примеры:
  - ✅ `complete_example.dart` — полный пример с обработкой ошибок и scoped клиентами.
  - ✅ `auth_example.dart` — примеры различных методов аутентификации (bearer token, API key).
  - ✅ `error_handling_example.dart` — обработка ошибок, retry логика, обработка специфичных статус-кодов.

## v0.5+ — Расширенный DX, тестирование и «полировка»

Дальнейшие версии можно развивать итеративно, в духе `dart_swagger_to_models`:

- **0.5.0 Тестовый контур и стабильность** ✅
  - ✅ Unit‑тесты для генераторов (`endpoint_method_generator_test.dart`).
  - ✅ Интеграционные тесты для полного цикла генерации (`api_client_generator_test.dart`).
  - ✅ Тесты для конфигурации и валидации.
  - ✅ Интеграционные тесты на httpbin.org (`integration_test.dart`) — опциональные, включаются через `--dart-define=ENABLE_INTEGRATION_TESTS=true`.
  - ✅ Регрессионные тесты для разных версий OpenAPI/Swagger (`regression_test.dart`) — OpenAPI 3.0.0, 3.1.0, различные сценарии.
  - ✅ Тесты для edge cases (`edge_cases_test.dart`) — пустые specs, невалидные параметры, неподдерживаемые методы.
  - ✅ Master test file (`dart_swagger_to_api_client_test.dart`) для организации всех тестов.

- **0.6.0 Advanced DX**
  - Watch‑режим (`--watch`) для авто‑регенерации клиента.
  - Предпросмотр diff перед перезаписью файлов.
  - Интерактивный режим выбора части endpoints.

- **0.7.0 Middleware и ретраи**
  - Middleware‑цепочка для запросов/ответов:
    - логирование, ретраи, rate‑limit обработка.
  - Подключаемые пользовательские интерсепторы.

- **0.8.0 Интеграции**
  - Примеры/генерация кода для интеграции со state management (Riverpod/BLoC) поверх клиента.
  - CI‑шаблоны для автоматической регенерации клиента.

---

## Текущий статус и приоритеты

### Что сделано сверх плана

1. **Валидация спецификации** (`SpecValidator`) — реализована раньше, чем планировалось в v0.2.3.
   - Детальные предупреждения о неподдерживаемых фичах.
   - Проверка наличия `operationId`, неподдерживаемых content types, параметров.

2. **Поддержка всех основных HTTP методов** — реализовано в v0.1 вместо только GET/POST:
   - `GET`, `POST`, `PUT`, `DELETE`, `PATCH`.

3. **Инфраструктура для интеграции с моделями** — подготовлена заранее:
   - `ModelsResolver`, `ModelsConfig`, `ModelsConfigLoader` готовы к использованию.

### Приоритетные задачи (ближайшие шаги)

#### Высокий приоритет

1. **Завершить v0.2.1** — интегрировать таймауты в `HttpHttpClientAdapter`.
   - Использовать `ApiClientConfig.timeout` при отправке запросов.
   - Простая задача, улучшает качество кода.

2. ✅ **Реализовать реальный `ModelsResolver`** (v0.4.2) — **ЗАВЕРШЕНО**

3. ✅ **Добавить поддержку `application/x-www-form-urlencoded`** (v0.2.2) — **ЗАВЕРШЕНО**

#### Средний приоритет

4. ✅ **Поддержка header/cookie параметров** (v0.4.1) — **ЗАВЕРШЕНО**

5. **Поддержка `multipart/form-data`** (v0.4.1):
   - Более сложная задача, требует работы с файлами.
   - Можно отложить до реальной необходимости.

6. ✅ **Добавить адаптер для `dio`** (v0.3.1) — **ЗАВЕРШЕНО**

#### Низкий приоритет

7. **Watch‑режим** (v0.6.0):
   - Удобно для разработки, но не критично для MVP.

8. **Middleware и ретраи** (v0.7.0):
   - Продвинутая функциональность, можно отложить.

### Рекомендуемый порядок работы

1. ✅ **v0.1** — завершено
2. ✅ **v0.2.1** — интегрировать таймауты — **ЗАВЕРШЕНО**
3. ✅ **v0.4.2** — реализовать реальный `ModelsResolver` — **ЗАВЕРШЕНО**
4. ✅ **v0.2.2** — добавить `application/x-www-form-urlencoded` — **ЗАВЕРШЕНО**
5. ✅ **v0.4.1** — header/cookie параметры — **ЗАВЕРШЕНО** (частично, без multipart/form-data)
6. ✅ **v0.3.1** — адаптер для `dio` — **ЗАВЕРШЕНО** (частично, без custom адаптеров)
7. ✅ **v0.4.3** — улучшить документацию и примеры — **ЗАВЕРШЕНО**
8. ✅ **v0.5.0** — расширенный DX и тестирование — **ЗАВЕРШЕНО**

---

**Последнее обновление**: после реализации валидации спецификации и улучшения DX.
